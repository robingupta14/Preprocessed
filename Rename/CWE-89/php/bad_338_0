<?php



if (!getperms('4'))
{
	e107::redirect('admin');
	exit();
}


e107::coreLan('banlist', true);

e107::js('footer-inline', "

		$('

			var id = $(this).attr('data-ip');
			$('
			event.preventDefault();
		});

");


class class_0 extends var_1
{

	protected $var_2 = array(	
	
		'main'	=> array(
			'controller' 	=> 'banlist_ui',
			'path' 			=> null,
			'ui' 			=> 'banlist_form_ui',
			'uipath' 		=> null
		),
		'white'	=> array(
			'controller' 	=> 'banlist_ui',
			'path' 			=> null,
			'ui' 			=> 'banlist_form_ui',
			'uipath' 		=> null
		),
		'failed'	=> array(
			'controller' 	=> 'failed_ui',
			'path' 			=> null,
			'ui' 			=> 'failed_form_ui',
			'uipath' 		=> null
		),

	);	
	
	
	protected $var_3 = array(

		'main/list'			=> array('caption'=> var_4, 'perm' => '4'),
		'main/create'		=> array('caption'=> var_5, 'perm' => '4'),
		'other'            => array('divider'=>true),
		
		'white/list'		=> array('caption'=> var_6, 'perm' => '4'),
		'white/create'		=> array('caption'=> var_7, 'perm' => '4'),

		'other1'            => array('divider'=>true),

		'failed/list'       => array('caption'=> var_8, 'perm'=>'4'),

		'other2'            => array('divider'=>true),
		'main/transfer'		=> array('caption'=> var_9, 'perm' => '4'),
		'main/times'		=> array('caption'=> var_10, 'perm' => '0'),
		'main/options'		=> array('caption'=> var_11, 'perm' => '0'),

	);

	protected $var_12 = array(
		'main/edit'	=> 'main/list'						
	);	
	
	protected $var_13 = var_14;

	protected $var_15 = 'e-banlist-24';
}




				
class class_1 extends var_16
{
			
		protected $var_17		= var_14;
		protected $var_18		= 'ban';
		protected $var_19			= 'banlist';
		protected $var_20				= 'banlist_id'; 
		protected $var_21 			= 10;
		protected $var_22          = "SELECT * FROM `
		protected $var_23		= 'banlist_datestamp DESC';

		protected $var_24 	= array (  
		  'checkboxes' 			=>   array ( 'title' => '', 				'type' => null, 		'data' => null, 'width' => '5%', 'thclass' => 'center', 'forced' => '1', 'class' => 'center', 'toggle' => 'e-multiselect',  ),
		  'banlist_id'			 =>  array ( 'title' => LAN_ID, 			'data' => 'int',        'width' => '5%', 'help' => '', 'readParms' => '', 'writeParms' => '', 'class' => 'left', 'thclass' => 'left',  ),
		  'banlist_ip' 			=>   array ( 'title' => BANLAN_126, 			'type' => 'method', 		'data' => 'str', 'width' => 'auto', 'help' => '', 'readParms' => '', 'writeParms' => '', 'class' => 'left', 'thclass' => 'left',  ),
		  'banlist_bantype' 	=>   array ( 'title' => LAN_TYPE, 			'type' => 'method', 	'data' => 'str', 'width' => 'auto', 'filter'=>true, 'help' => '', 'readParms' => '', 'writeParms' => '', 'class' => 'left', 'thclass' => 'left',  ),
		  'banlist_datestamp' 	=>   array ( 'title' => LAN_DATESTAMP, 		'type' => 'datestamp', 	'data' => 'int', 'width' => 'auto', 'filter' => true, 'help' => '', 'readParms' => '', 'writeParms' => 'auto=1&hidden=1&readonly=1', 'class' => 'left', 'thclass' => 'left',  ),
		  'banlist_banexpires' 	=>   array ( 'title' => BANLAN_124,	 		'type' => 'method', 	'data' => 'int', 'inline'=>true, 'width' => 'auto', 'batch' => true, 'filter' => true, 'help' => '', 'readParms' => '', 'writeParms' => '', 'class' => 'left', 'thclass' => 'left',  ),
		  'banlist_admin' 		=>   array ( 'title' => 'Admin', 			'type' => 'text', 	    'data' => 'int', 'noedit'=>true, 'width' => 'auto', 'help' => '', 'readParms' => '', 'writeParms' => '', 'class' => 'center', 'thclass' => 'center',  ),
		  'banlist_reason' 		=>   array ( 'title' => BANLAN_7, 			'type' => 'text', 		'data' => 'str', 'inline'=>true, 'width' => 'auto', 'help' => '', 'readParms' => 'constant=1', 'writeParms' => array('size'=>'xxlarge'), 'class' => 'left', 'thclass' => 'left',  ),
		  'banlist_notes' 		=>   array ( 'title' => BANLAN_19, 			'type' => 'text', 		'data' => 'str', 'inline'=>true, 'width' => 'auto', 'help' => '', 'readParms' => '', 'writeParms' => array('size'=>'xxlarge'), 'class' => 'left', 'thclass' => 'left',  ),
		  'options' 			=>   array ( 'title' => LAN_OPTIONS, 		'type' => '', 			'data' => '', 'width' => '10%', 'thclass' => 'center last', 'class' => 'center last', 'forced' => '1',  ),
		);		
		
		protected $var_25 = array('checkboxes', 'banlist_ip', 'banlist_bantype', 'banlist_datestamp', 'banlist_banexpires', 'banlist_reason', 'banlist_notes', 'options');

		
	
	
	
	
	


		function CreateObserver()
		{
			parent::CreateObserver();
			$var_26->var_24['banlist_ip']['title']= BANLAN_5;
		}

		function EditObserver()
		{
			parent::EditObserver();
			$var_26->var_24['banlist_ip']['title']= BANLAN_5;
		}

		
		
		public function init()
		{

			if($var_26->var_27() == 'white')
			{
				if($var_26->var_28() == 'list')
				{
					$var_26->var_22 = "var_29 * var_30 `
				}


				if($var_26->var_28() == 'create')
				{
					$var_31 = e107::getIPHandler()->getIP(true);
					$var_26->var_24['banlist_ip']['writeParms']['tdClassRight']  = 'form-inline';
					$var_26->var_24['banlist_ip']['writeParms']['pre'] = "<div class='input-append'>";
					$var_26->var_24['banlist_ip']['writeParms']['post'] = "<button class='btn btn-primary' id='useip' data-ip='{$var_31}'>".BANLAN_125."</button></div>"; 
				}

			}


			if (isset($var_50['var_32']))		
			{
				$var_26->var_33(); 	
			}
		}


		public function beforeCreate($var_34, $var_35, $var_36)
		{
			$var_34['var_0'] = ADMINID;

			if(filter_var($var_34['var_37'], FILTER_VALIDATE_IP)) 
			{
				$var_34['var_37'] = e107::getIPHandler()->ipEncode($var_34['var_37']);
			}

			return $var_34;
		}

		public function beforeUpdate($var_34, $var_35, $var_36)
		{
			$var_34['var_0'] = ADMINID;

			if(filter_var($var_34['var_37'], FILTER_VALIDATE_IP)) 
			{
				$var_34['var_37'] = e107::getIPHandler()->ipEncode($var_34['var_37']);
			}

			return $var_34;
		}





		public function afterCreate($var_34, $var_35, $var_36)
		{
			e107::getIPHandler()->regenerateFiles();
		}

		public function afterUpdate($var_34, $var_35, $var_36)
		{
			e107::getIPHandler()->regenerateFiles();
		}

		public function afterDelete($var_38, $var_36, $var_39)
		{

			e107::getIPHandler()->regenerateFiles();
		}


		public function addPage()
		{
			
			
			
		}

		
		public function transferPage()
		{
			
		}
		
	
		
		private function timesPageSave()
		{


			$var_40 = new banlistManager;
			$var_41 = e107::getParser();
			$var_42 = false;

			$var_43 = array();

			$var_44 = $var_40->var_45();
			foreach ($var_40->var_45() as $var_46)
			{
				$var_47 = abs($var_46) + 1;		
				$var_48 = $var_41->var_49(varset($var_50['var_51'.($i)],''));
				$var_52 = intval(varset($var_50['ban_time_'.($var_47)],0));
				var_53 (!var_54($var_43['var_55'][$var_46]) || ($var_43['var_55'][$var_46] != $var_48))
				{
					$var_43['var_55'][$var_46] = $var_48;
					$var_42 = TRUE;
				}
				if (!isset($var_43['ban_durations'][$var_46]) || ($var_43['ban_durations'][$var_46] != $var_52))
				{
					$var_43['ban_durations'][$var_46] = $var_52;
					$var_42 = TRUE;
				}
			}

			if ($var_42 && !empty($var_43))
			{
			
				e107::getConfig()->setPref($var_43)->save(); 
			
				
				$var_40->writeBanMessageFile();
				fn_17('08','');
				
			
			}	
			
			
		}



		
		protected function fn_1()
		{
			if (!getperms('0'))
			{
				return;
			}
			
			$var_43 = e107::getPref();
			$var_41 = e107::getParser();		
			$var_59 = e107::getForm();
			$var_60 = e107::getMessage();
			
			$var_40 = new class_2;
						
			$var_61 = '';
			if ((!isset($var_43['ban_messages'])) || !is_array($var_43['ban_messages']))
			{
				foreach ($var_40->getValidReasonList() as $var_46)
				{
					$var_43['ban_messages'][$var_46] = '';
				}
			}
			if ((!isset($var_43['ban_durations'])) || !is_array($var_43['ban_durations']))
			{
				foreach ($var_40->getValidReasonList() as $var_46)
				{
					$var_43['ban_durations'][$var_46] = 0;
				}
			}
	
			$var_61 .= "
				<form method='post' action='".var_62.'?'.var_63."' id='ban_options'>
					<fieldset id='core-banlist-times'>
						<legend class='e-hideme'>".var_64."</legend>
						<table class='table adminlist'>
							<colgroup>
								<col style='width: 20%' />
								<col style='width: 65%' />
								<col style='width: 15%' />
							</colgroup>
							<thead>
								<tr>
									<th>".var_65."</th>
									<th>".var_66."<br />".var_67."</th>
									<th class='center last'>".var_68."</th>
								</tr>
							</thead>
							<tbody>
			";
			foreach ($var_40->getValidReasonList() as $var_46)
			{
				$var_47 = abs($var_46) + 1;		
				$var_61 .= "
						<tr>
							<td>
								<strong>".$var_40->getBanTypeString($var_46, FALSE)."</strong>
								<div class='field-help'>".$var_40->getBanTypeString($var_46, TRUE)."</div>
							</td>
							<td class='left'>
								".$var_59->textarea('ban_text_'.($var_47), $var_43['ban_messages'][$var_46], 4, 120, array('size'=>'xxlarge'))."
							</td>
							<td class='center'>".fn_12('', var_71, $var_43['ban_durations'][$var_46], 'ban_time_'.($var_47))."</td>
						</tr>
					";
			}
			$var_61 .= "
							</tbody>
						</table>
						<div class='buttons-bar center'>
							".$var_59->admin_button('update_ban_prefs', var_73, 'update')."
							<input type='hidden' name='e-token' value='".var_74."' />
						</div>
					</fieldset>
				</form>
				";
	
			 
		}		

		
		protected function fn_2()
		{
			
		}				

		protected function fn_3()
		{
			
		}	

}
				


class class_3 extends var_75
{

	
	function fn_4($var_77,$var_78) 
	{

		switch($var_78)
		{
			case 'read': 

				break;

			case 'write': 
				return $var_26->renderElement('banlist_reason', $var_77, array());
				break;

			case 'filter':
			case 'batch':

				break;
		}
	}

	
	function fn_0($var_77,$var_78) 
	{

		if(!empty($var_77))
		{
			$var_80 = explode(":",$var_77);

			if(count($var_80) === 8)
			{
				$var_77 = e107::getIPHandler()->ipDecode($var_77);
			}
		}

		switch($var_78)
		{
			case 'read': 
				return $var_77;
				break;

			case 'write': 

				return $var_26->text('banlist_ip', $var_77, array());
				break;

			case 'filter':
			case 'batch':

				break;
		}
	}

	
	
	function fn_5($var_77,$var_78)
	{
	
		$var_40 = new class_2;
		
		
		 		
		switch($var_78)
		{
			case 'read': 
				return "<div class='nowrap' title='".$var_40->getBanTypeString($var_77, TRUE)."'>".$var_40->getBanTypeString($var_77, FALSE)."</div>";					
			break;
			
			case 'write': 

				if ($var_26->getController()->getMode() == 'white')
				{
					return $var_26->hidden('banlist_bantype',var_85::var_86)."<span class='label label-success'>".var_87."</span>";
				}
				elseif($var_26->getController()->getAction() == 'create')
				{
					return $var_26->hidden('banlist_bantype',var_85::var_88)."<span class='label label-important label-danger'>".var_89."</span>";
				}



				return $var_26->selectbox('banlist_bantype',$var_40->var_91, $var_77);
			break;
			
			case 'filter':
			case 'batch':
				return  $var_40->var_91; 
			break;
		}
	}

	
	
	function fn_6($var_77,$var_78)
	{
		
		$var_43 = e107::getPref();
		$var_93 = e107::getDate();
		$var_94 = $var_26->banexpires();
			 		
		switch($var_78)
		{
			case 'read': 
				$var_36 = $var_26->getController()->getListModel()->get('banlist_ip');
			
			
				
				$var_98 = vartrue($var_77) ? $var_93->computeLapse(time(), $var_77) : var_100;

				$var_98 = str_replace("ago", "", $var_98); 
				
				if(vartrue($var_77) && $var_77 < time())
				{
					$var_98 = 	var_101;
				}
									
				$var_102 = str_replace('"',"'",json_encode($var_94));
				return "<a class='e-tip e-editable' data-name='banlist_banexpires' data-source=\"".$var_102."\"  data-type='select' data-pk='".$var_36."' data-url='".var_62."?mode=&amp;action=inline&amp;id={$var_36}&amp;ajax_used=1' href='
				
			break;
			
			case 'write': 
				if(!empty($var_77))
				{
					$var_94[$var_77] = e107::getParser()->toDate($var_77, 'short');
				}

				return $var_26->var_90('banlist_banexpires',$var_94, $var_77);
				
			break;
			
			case 'filter':
			case 'batch':
				return  false;
			break;
		}
	}


	function banexpires()
	{
		$var_103 = array(0, 1, 2, 3, 6, 8, 12, 24, 36, 48, 72, 96, 120, 168, 336, 672);

		$var_94 = array();

		foreach ($var_103 as $var_47)
		{
			$var_104 = "";
			
			if ($var_47 == 0)
			{
				$var_94[$var_47]  = var_100;
				continue;
			}
			elseif (($var_47 % 24) == 0 && $var_47 !== 24)
			{
				$var_104 = floor($var_47 / 24).' '.var_105;
			}
			else
			{
				$var_104 = $var_47.' '.var_106;
			}
			
			$var_107 = time() + ($var_47 * 60 * 60);
			
			$var_94[$var_107] = $var_104; 
		}
	
		return $var_94;		
	}

}




	class class_4 extends var_16
	{

		protected $var_17		= var_14;
		protected $var_108		= 'failed_login';
		protected $var_19			= 'generic';
		protected $var_20				= 'gen_id';
		protected $var_21 			= 10;
		protected $var_22			= "SELECT * FROM `
		protected $var_23        = "var_109 var_110";

		protected $var_24 		= array (  'checkboxes' =>   array ( 'title' => '', 'type' => null, 'data' => null, 'width' => '5%', 'thclass' => 'center', 'forced' => '1', 'class' => 'center', 'toggle' => 'e-multiselect',  ),
		                                    'gen_id' 				=> array ( 'title' => var_111,	 'nolist'=>true,	'data' => 'int', 'width' => '5%', 'help' => '', 'readParms' => '', 'writeParms' => '', 'class' => 'left', 'thclass' => 'left',  ),
			
		                                    'gen_datestamp' 		=> array ( 'title' => var_112, 'type' => 'datestamp', 'data' => 'int', 'width' => 'auto', 'filter' => true, 'help' => '', 'readParms' => '', 'writeParms' => '', 'class' => 'left', 'thclass' => 'left',  ),
		                                    'gen_chardata' 		=> array ( 'title' => var_113, 'type' => 'method', 'data' => 'str', 'width' => '40%', 'help' => '', 'readParms' => '', 'writeParms' => '', 'class' => 'left', 'thclass' => 'left', 'filter'=>true ),

			
		                                    'gen_ip' 				=> array ( 'title' => var_114, 'type' => 'ip', 'data' => 'str', 'width' => 'auto', 'help' => '', 'readParms' => '', 'writeParms' => '', 'class' => 'left', 'thclass' => 'left',  ),
			
		                                    'options'				=> array ( 'title' => var_11, 'type' => null, 'data' => null, 'width' => '10%', 'thclass' => 'center last', 'class' => 'center last', 'forced' => '1', 'readParms'=>'edit=0'  ),
		);

		protected $var_25 = array('gen_datestamp', 'gen_ip', 'gen_chardata');

		protected $var_115 = array();

		
		public function fn_7()
		{
			if($var_50['etrigger_batch'] == 'gen_intdata__1' && count($var_50['e-multiselect'])) 
			{
				$var_116 = implode(',',$var_50['e-multiselect']);
				
			}

			$var_117 = e107::getDB()->count('generic', '(*)', "gen_type='failed_login'");

			$var_26->var_115 = array('delete-all'=>str_replace('[x]', $var_117, var_119));

			if(!empty($var_50['etrigger_batch']) && $var_50['etrigger_batch'] == "delete-all")
			{
				$var_26->fn_8();
			}

		
		}

		private function fn_8()
		{

			if(e107::getDB()->delete('generic', "gen_type='failed_login'"))
			{
				e107::getMessage()->addSuccess(var_123);
			}
		}

		public function fn_9($var_124)
		{
			
		}

	}



	class class_5 extends var_75
	{


		
		function fn_10($var_77,$var_78)
		{
			$var_59 = e107::getForm();

			switch($var_78)
			{
				case 'read': 
					return $var_77;
					break;

				case 'write': 
					return $var_59->text('gen_type',$var_77);
					break;

				case 'filter':
				case 'batch':
					return  array(1=>var_125);
					break;
			}
		}


		
		function fn_11($var_77,$var_78)
		{
			$var_59 = e107::getForm();

			switch($var_78)
			{
				case 'read': 
					return str_replace(":::","<br />",$var_77);
					break;

				case 'write': 
					return $var_59->text('gen_chardata',$var_77);
					break;

				case 'filter':
				case 'batch':
					
					break;
			}
		}

	}


	new class_0();

e107::getAdminUI()->runPage();















$var_127 = 'banlist';
$var_59 = e107::getForm();


$var_60 = e107::getMessage();

$var_43 = e107::getPref();


if (!isset($var_43['ban_date_format'])) $var_43['ban_date_format'] = '%H:%M %d-%m-%y';

$var_40 = new class_2;


$var_128 = array(1 => ',', 2 => '|');
$var_129 = array(1 => '(none)', 2 => "'", 3 => '"');


$var_130 = 'list';
if (var_63)
{
	$var_80 = explode('-', var_63);		
	$var_130 = $var_80[0];
	$var_131 = varset($var_80[1], '');
	if ($var_131) $var_131 = preg_replace('/[^\w*@\.:]*/', '', urldecode($var_131));
	$var_36 = intval(varset($var_80[2], 0));
	unset($var_80);
}

if($_GET['action']) 
{
	$var_130 = $_GET['action'];	
}





$var_132 = FALSE;
if (isset($var_50['ban_ip']))
{
	$var_50['ban_ip'] = trim($var_50['ban_ip']);
	$var_133 = preg_replace('/[^\w*@\.:]*/', '', urldecode($var_50['ban_ip']));
	if ($var_133 != $var_50['ban_ip'])
	{
		$var_134 = var_135.' '.$var_133;
		
		$var_60->add(var_137, $var_134);
		$var_50['ban_ip'] = $var_133;
	}

	if (isset($var_50['entry_intent']) && (isset($var_50['add_ban']) || isset($var_50['update_ban'])) && $var_50['ban_ip'] != "" && strpos($var_50['ban_ip'], ' ') === false)
	{
		
		if(e107::getIPHandler()->whatIsThis($var_133) == 'ip')
		{
			$var_133 = e107::getIPHandler()->IPencode($var_133, TRUE); 
		}
		$var_140 = array('banlist_ip' => $var_133);
		if (isset($var_50['add_ban']))
		{
			$var_140['banlist_datestamp'] = time();
			if ($var_50['entry_intent'] == 'add') $var_140['banlist_bantype'] = var_85::var_88;		
			if ($var_50['entry_intent'] == 'whadd') $var_140['banlist_bantype'] = var_85::var_86;
		}
		$var_140['banlist_admin'] = var_141;
		$var_140['banlist_reason'] = $var_41->toDB(varset($var_50['ban_reason'], ''));
		$var_140['banlist_notes'] = $var_41->toDB($var_50['ban_notes']);
		if (isset($var_50['ban_time']) && is_numeric($var_50['ban_time']) && (($var_50['entry_intent']== 'edit') || ($var_50['entry_intent'] == 'add')))
		{
			$var_46 = intval($var_50['ban_time']);
			$var_140['banlist_banexpires'] = $var_46 ? time() + ($var_46*60*60) : 0;
		}
		if (isset($var_50['add_ban']))
		{  
			e107::getMessage()->addAuto($var_143->db_Insert('banlist', $var_140), 'insert');
			if ($var_50['entry_intent'] == 'add')
			{
				fn_17('01', $var_140['banlist_ip']);		
			}
			else
			{
				fn_17('04', $var_140['banlist_ip']);		
			}
		}
		else
		{  
			$var_145 = '';
			$var_146 = '';
			foreach ($var_140 as $var_147 => $var_148)
			{
				$var_145 .= $var_146."`{$var_147}`='$var_148'";
				$var_146 = ', ';
			}
			e107::getMessage()->addAuto($var_143->db_Update('banlist', $var_145." WHERE banlist_ip='".$var_50['old_ip']."'"));
			if ($var_50['entry_intent'] == 'edit')
			{
				fn_17('09',$var_140['banlist_ip']);
			}
			else
			{
				fn_17('10',$var_140['banlist_ip']);
			}
		}
		unset($var_150);
		$var_132 = TRUE;
	}
}




if (($var_130 == 'remove' || $var_130 == 'whremove') && isset($var_50['ban_secure'])) 
{
	$var_143->db_Delete('generic', "gen_type='failed_login' AND gen_ip='{$var_131}'");
	e107::getMessage()->addAuto($var_143->db_Delete('banlist', "banlist_ip='{$var_131}'"), 'delete');
	if ($var_130 == "remove")
	{
		$var_130 = 'list';
		fn_17('02', $var_131);
	}
	else
	{
		$var_130 = 'white';
		fn_17('05', $var_131);
	}
	$var_132 = TRUE;
}




if ($var_130 == 'newtime')
{
	$var_152 = $var_36 ? time() + ($var_36*60*60) : 0;
	e107::getMessage()->addAuto($var_143->db_Update('banlist', 'banlist_banexpires='.intval($var_152)." WHERE banlist_ip='".$var_131."'"));
	fn_17('03', $var_131);
	$var_130 = 'list';
	$var_132 = TRUE;
}


if ($var_132)
{

	$var_40->writeBanListFiles('ip,htaccess');
	if (!$var_40->doesMessageFileExist())
	{
		$var_40->writeBanMessageFile();		
		fn_17('08','');
		$var_60->addSuccess(var_155);
	}
}





if ($var_130 == 'edit' || $var_130 == 'whedit')
{
	$var_143->db_Select('banlist', '*', "banlist_ip='{$var_131}'");
	$var_157 = $var_143->db_Fetch();
	extract($var_157);				
}
else
{
	unset($var_37, $var_76);
	if (var_63 && ($var_130 == 'add' || $var_130 == 'whadd') && strpos($_SERVER["HTTP_REFERER"], "userinfo"))
	{
		$var_37 = $var_131;
	}
}




function fn_12($var_159 = '', $var_160 = var_100, $var_161 = -1, $var_162 = 'ban_time')
{
	$var_59 = e107::getForm();
	$var_103 = array(0, 1, 2, 3, 6, 8, 12, 24, 36, 48, 72, 96, 120, 168, 336, 672);

	$var_163 = $var_59->select_open($var_162, array('other' => $var_159, 'id' => false));
	$var_163 .= $var_59->option('&nbsp;', '');
	foreach ($var_103 as $var_47)
	{
		if ($var_47 == 0)
		{
			$var_104 = $var_160 ? $var_160 : var_100;
		}
		elseif (($var_47 % 24) == 0)
		{
			$var_104 = floor($var_47 / 24).' '.var_105;
		}
		else
		{
			$var_104 = $var_47.' '.var_106;
		}
		$var_163 .= $var_59->option($var_104, $var_47, ($var_161 == $var_47));
	}
	$var_163 .= '</select>';
	return $var_163;
}





function fn_13($var_166, $var_124, $var_161 = FALSE)
{
	global $var_59;

	$var_163 = $var_59->select_open($var_166, array('class' => 'tbox', 'id' => false));
	foreach ($var_124 as $var_147 => $var_148)
	{
		$var_163 .= $var_59->option($var_148, $var_147, ($var_161 !== FALSE) && ($var_161 == $var_147));
	}
	$var_163 .= "</select>\n";
	return $var_163;
}




function fn_14($var_167, $var_161)
{
	global $var_59;

	$var_94 = array(50, 100, 150, 200, 250, 300, 400, 500);
	$var_163 = $var_59->select_open($var_167, array('class' => 'tbox'));
	foreach ($var_94 as $var_168)
	{
		$var_163 .= $var_59->option($var_168, $var_168, ($var_161 == $var_168));
	}
	$var_163 .= "</select>\n";
	return $var_163;
}



$var_61 = '';


switch ($var_130)
{
	case 'banlog' :
		if(!getperms('0')) var_169;
		if (isset($var_50['delete_ban_log']))
		{
			$var_134 = ($var_40->deleteLogFile() ? var_171 : var_172);
			e107::getRender()->tablerender(var_174, "<div style='text-align:center; font-weight:bold'>".$var_134."</div>"); 
		}
		$var_175 = 0;
		$var_176 = 20;		
		if ($var_131) $var_175 = intval($var_131);


		$var_61 = "<div style='text-align:center'>
		<form method='post' action='".var_62."?banlog-".$var_175."'>
		<table class='table adminform'>
		<colgroup>
			<col style='width:20%; vertical-align:top;' />
			<col style='width:30%; vertical-align:top;' />
			<col style='width:30%; vertical-align:top;' />
			<col style='width:30%; vertical-align:top;' />
		</colgroup>";

		
		$var_177 = $var_40->getLogEntries($var_175, $var_176, $var_179);
		if (count($var_177) == 0)
		{
		  $var_61 .= "<tbody><tr><td colspan='4'>".var_180."</td></tr>";
		  $var_179 = 0;
		}
		else
		{
			$var_61 .= "<thead><tr><td class='fcaption'>".var_181."</td><td class='fcaption'>".var_182."</td>
				<td class='fcaption'>".var_183."</td><td class='fcaption'>".var_184."</td></tr></thead><tbody>";
			foreach ($var_177 as $var_185)
			{
				$var_157 = $var_40->splitLogEntry($var_185);
				$var_61 .= "
					<tr>
					<td class='forumheader3'>".strftime($var_43['ban_date_format'], $var_157['banDate'])."</td>
					<td class='forumheader3'>".e107::getIPHandler()->ipDecode($var_157['banIP'])."</td>
					<td class='forumheader3'>".$var_40->getBanTypeString($var_157['banReason'], FALSE)."</td>
					<td class='forumheader3'>".$var_157['banNotes']."</td>
					</tr>";
			}  

			
			if ($var_179 > $var_176) 
			{
				$var_187 = "{$var_179},{$var_176},{$var_175},".var_62."?".$var_130.'-[FROM]';
				$var_61 .= "<tr><td colspan='5' style='text-align:center'><br />".$var_41->parseTemplate("{NEXTPREV={$var_187}}".'<br /><br /></td></tr>');
			}
			$var_61 .= "<tr><td colspan='4' style='text-align:center'>
						<input class='btn btn-default btn-secondary button' type='submit' name='delete_ban_log' value='".var_174."' />
						<input type='hidden' name='e-token' value='".var_74."' />
					</td>
					  </tr>";
		}
		$var_61 .= "</tbody></table></form></div>";

		if (count($var_177))
		{
			$var_61 .= "&nbsp;&nbsp;&nbsp;".str_replace('[y]', $var_179, var_189);
		}
		
		 
	
		break;


	case 'options' :
		if (!getperms('0'))
			exit();
		if (isset($var_50['update_ban_options']))
		{
			$var_43['enable_rdns'] = intval($var_50['ban_rdns_on_access']);
			$var_43['enable_rdns_on_ban'] = intval($var_50['ban_rdns_on_ban']);
			$var_43['ban_max_online_access'] = intval($var_50['ban_access_guest']).','.intval($var_50['ban_access_member']);
			$var_43['ban_retrigger'] = intval($var_50['ban_retrigger']);
			$var_43['ban_date_format'] = $var_41->toDB($var_50['ban_date_format']);
			save_prefs();						
			$var_60->addSuccess(var_190);
		}

		if (isset($var_50['remove_expired_bans']))
		{
			$var_191 = $var_143->db_Delete('banlist',"`banlist_bantype` < ".var_85::var_86." AND `banlist_banexpires` > 0 AND `banlist_banexpires` < ".time());
			fn_17('12', $var_191);
			$var_60->addSuccess(str_replace('[y]', $var_191, var_192));
		}

		list($var_193, $var_194) = explode(',', varset($var_43['ban_max_online_access'], '100,200'));
		$var_194 = max($var_193, $var_194);
		$var_61 = "
			<form method='post' action='".var_62."?options'>
				<fieldset id='core-banlist-options'>
					<legend>".var_195."</legend>
					<table class='table adminform'>
						<colgroup>
							<col class='col-label' />
							<col class='col-control' />
						</colgroup>
						<tbody>
							<tr>
								<td>".var_196."</td>
								<td>
									<div class='auto-toggle-area autocheck'>
										".$var_59->checkbox('ban_rdns_on_access', 1, $var_43['enable_rdns'] == 1)."
										<div class='field-help'>".var_198."</div>
									</div>
								</td>
							</tr>
							<tr>
								<td>".var_199."</td>
								<td>
									<div class='auto-toggle-area autocheck'>
										".$var_59->checkbox('ban_rdns_on_ban', 1, $var_43['enable_rdns_on_ban'] == 1)."
										<div class='field-help'>".var_200."</div>
									</div>
								</td>
							</tr>
							<tr>
								<td>".var_201."</td>
								<td>
									<div class='field-spacer'>".fn_14('ban_access_guest', $var_193).var_202."</div>
									<div class='field-spacer'>".fn_14('ban_access_member', $var_194).var_203."</div>
									<div class='field-help'>".var_204."</div>
								</td>
							</tr>
							<tr>
								<td>".var_205."</td>
								<td>
									<div class='auto-toggle-area autocheck'>
										".$var_59->checkbox('ban_retrigger', 1, $var_43['ban_retrigger'] == 1)."
										<div class='field-help'>".var_206."</div>
									</div>
								</td>
							</tr>

							<tr>
							  <td>".var_207."</td>
							  <td>
							  ".$var_59->text('ban_date_format', varset($var_43['ban_date_format'], '%H:%M %d-%m-%y'), 40)."
							  <div class='field-help'>".var_208."</div>
							  </td>
							</tr>
						</tbody>
					</table>
					<div class='buttons-bar center'>
						".$var_59->admin_button('update_ban_options', var_73, 'update')."
						<input type='hidden' name='e-token' value='".var_74."' />
					</div>
				</fieldset>
				<fieldset id='core-banlist-options-ban'>
					<legend>".var_209."</legend>
					<table class='table adminform'>
						<colgroup>
							<col class='col-label' />
							<col class='col-control' />
						</colgroup>
						<tbody>
							<tr>
								<td>".var_210."</td>
								<td>
									".$var_59->admin_button('remove_expired_bans', var_211, 'delete')."
									<input type='hidden' name='e-token' value='".var_74."' />
								</td>
							</tr>
						</tbody>
					</table>
				</fieldset>
			</form>
		";
		
		 
		
	
		break;

	case 'times' :

			
	
		break;

	case 'edit' :		
	case 'add' :		
	case 'whedit' :		
	case 'whadd' :		
	
		if(!var_212)
		{
			break;	
		}
		RETURN;
	
		if (!isset($var_76)) $var_76 = '';
		if (!isset($var_37)) $var_37 = '';
		if (!isset($var_213)) $var_213 = '';

		$var_214 = array('edit' => var_215, 'add' => var_216, 'whedit' => var_217, 'whadd' => var_218);
		$var_219 = vartrue($var_43['enable_rdns']) ? '' : '<div class="field-help error">'.var_220.'</div>';
		$var_221 = ($var_130 == 'whedit' || $var_130 == 'whadd') ? '?white' : '?list';
		
		$var_61 .= "
			<form method='post' action='".var_62.$var_221."'>
				<fieldset id='core-banlist-edit'>
					<legend class='e-hideme'>".$var_214[$var_130]."</legend>
					<table class='table adminform'>
						<colgroup>
							<col class='col-label' />
							<col class='col-control' />
						</colgroup>
						<tbody>
							<tr>
								<td>
									".var_222.":
									<div class='label-note'>
										".var_223."<a href='".var_224."users.php'>".var_225."</a>
									</div>
								</td>
								<td>
									<input type='hidden' name='entry_intent' value='{$var_130}' />
									".$var_59->text('ban_ip', e107::getIPHandler()->ipDecode($var_37), 200)."
									{$var_219}
								</td>
							</tr>
		";

		if (($var_130 == 'add') || ($var_130 == 'whadd') || ($var_82 <= 1) || ($var_82 >= var_85::var_86))
		{ 
			$var_61 .= "
							<tr>
								<td>".var_183.": </td>
								<td>
									".$var_59->textarea('ban_reason', $var_76, 4, 50)."
								</td>
							</tr>
			";
		}
		elseif ($var_130 == 'edit')
		{
			$var_61 .= "
							<tr>
								<td>".var_183.": </td>
								<td>{$var_76}</td>
							</tr>
			";
		}

		if ($var_130 == 'edit')
		{
			$var_61 .= "
							<tr>
								<td>".var_65.": </td>
								<td>".$var_40->getBanTypeString($var_82, FALSE)." - ".$var_40->getBanTypeString($var_82, TRUE)."</td>
							</tr>
			";
		}

		$var_61 .= "
							<tr>
								<td>".var_226.": </td>
								<td>
									".$var_59->textarea('ban_notes', $var_213, 4, 50)."
								</td>
							</tr>
		";

		if ($var_130 == 'edit' || $var_130 == 'add')
		{
			$var_227 = (($var_130 == 'edit') ? '<div class="field-help">'.var_228.($var_92 ? strftime($var_43['ban_date_format'], $var_92) : var_100).'</div>' : '');

			$var_61 .= "
							<tr>
								<td>".var_229.": </td>
								<td>".fn_12().$var_227."</td>
							</tr>
			";
		}

		$var_61 .= "
						</tbody>
					</table>
					<input type='hidden' name='e-token' value='".var_74."' />
					<div class='buttons-bar center'>

		";

		

		if ($var_130 == 'edit' || $var_130 == 'whedit')
		{
			$var_61 .= "<input type='hidden' name='old_ip' value='{$var_37}' />
				".$var_59->admin_button('update_ban', var_73, 'update');
		}
		else
		{
			$var_61 .= $var_59->admin_button('add_ban', ($var_130 == 'add' ? var_230 : var_7), 'create');
		}

		$var_61 .= "</div>
				</fieldset>
			</form>
		";

		 
	
		break;		


	case 'transfer' :
		$var_134 = '';
		$var_231 = false;
		if (isset($var_50['ban_import']))
		{ 
			if (($var_232 = process_uploaded_files(var_233, FALSE, array('overwrite' => TRUE, 'max_file_count' => 1, 'file_mask' => 'csv'))) === FALSE)
			{ 
				$var_231 = true;
				$var_60->addError(var_235);
			}
			if(empty($var_232) || vartrue($var_232[0]['error']))
			{
				$var_231 = true;
				if(varset($var_232[0]['message']))
					$var_60->addError($var_232[0]['message']);
			}
			if(!$var_231)
			{ 
				$var_134 = process_csv(var_233.$var_232[0]['name'],
										intval(varset($var_50['ban_over_import'], 0)),
										intval(varset($var_50['ban_over_expiry'], 0)),
										$var_128[intval(varset($var_50['ban_separator'], 1))],
										$var_129[intval(varset($var_50['ban_quote'], 3))]);
				fn_17('07', 'File: '.var_233.$var_232[0]['name'].'<br />'.$var_134);
			}

		}

		$var_61 = "
			<form method='post' action='".var_224."banlist_export.php' id='core-banlist-transfer-form' >
				<fieldset id='core-banlist-transfer-export'>
					<legend>".var_236."</legend>
					<table class='table adminlist'>
						<colgroup>
							<col style='width:30%' />
							<col style='width:30%' />
							<col style='width:40%' />
						</colgroup>
						<tbody>
							<tr>
								<th colspan='2'>".var_237."</th>
								<th>&nbsp;</th>
							</tr>
			";


		foreach ($var_40->getValidReasonList() as $var_47) 
		{
			$var_61 .= "
							<tr>
							<td colspan='3'>
								".$var_59->checkbox("ban_types[{$var_47}]", $var_47).$var_59->label($var_40->getBanTypeString($var_47, FALSE), "ban_types[{$var_47}]", $var_47)."
								<span class='field-help'>(".$var_40->getBanTypeString($var_47, TRUE).")</span>
							</td></tr>
			";
		}

		$var_61 .= "<tr>
			<td>".var_239."</td>
			<td>".fn_13('ban_separator', $var_128).' '.var_240."</td>
		<td>".fn_13('ban_quote', $var_129).' '.var_241."</td></tr>";
		$var_61 .= "

						</tbody>
					</table>
					<div class='buttons-bar center'>".$var_59->admin_button('ban_export', var_242, 'export', var_242)."</div>
						<input type='hidden' name='e-token' value='".var_74."' />
				</fieldset>
			</form>
		";

		
		$var_61 .= "
			<form enctype='multipart/form-data' method='post' action='".var_62."?transfer' id='ban_import_form' >
				<fieldset id='core-banlist-transfer-import'>
					<legend>".var_243."</legend>
					<table class='table adminlist'>
						<colgroup>
							<col style='width:30%' />
							<col style='width:30%' />
							<col style='width:40%' />
						</colgroup>
						<tbody>
							<tr>
								<th colspan='2'>".var_244."</th>
								<th>&nbsp;</th>
							</tr>
							<tr>
								<td colspan='3'>".$var_59->checkbox('ban_over_import', 1, '', array('label' => var_245))."</td>
							</tr>
							<tr>
								<td colspan='3'>".$var_59->checkbox('ban_over_expiry', 1, '', array('label' => var_246))."</td>
							</tr>
							<tr>
								<td>".var_247."</td>
								<td colspan='2'>
									".$var_59->file('file_userfile[]', array('size' => '40'))."
								</td>
							</tr>
							<tr>
			<td>".var_249."</td>
			<td>".fn_13('ban_separator', $var_128).' '.var_240."</td>
		<td>".fn_13('ban_quote', $var_129).' '.var_241."</td></tr>
						</tbody>
					</table>
								<div class='buttons-bar center'>
								".$var_59->admin_button('ban_import', var_250, 'import')."
								<input type='hidden' name='e-token' value='".var_74."' />
								</div>


				</fieldset>
			</form>
		";

		 
	
		break;		

	case 'list' :
	case 'white' :
	default :
		
		if(!var_212)
		{
			break;	
		}
		
		if (($var_130 != 'list') && ($var_130 != 'white'))
			$var_130 = 'list';

		$var_251 = ($var_130 == 'list' ? 'edit' : 'whedit');
		$var_252 = ($var_130 == 'list' ? 'remove' : 'whremove');
		$var_253 = array('list' => array(10, 5, 35, 30, 10, 10), 'white' => array(15, 40, 35, 10));
		$var_254 = array('list' => array(var_255, var_256, var_257, var_226, var_229, var_11),
							'white' => array(var_258, var_259, var_226, var_11));
		$var_260 = array('list' => var_261, 'white' => var_262);
		$var_263 = array('list' => array('banlist_datestamp' => 0, 'banlist_bantype' => 0, 'ip_reason' => var_183, 'banlist_notes' => 0, 'banlist_banexpires' => 0, 'ban_options' => 0),
						'white' => array('banlist_datestamp' => 0, 'ip_reason' => var_264, 'banlist_notes' => 0, 'ban_options' => 0));

		$var_61 = "
			<form method='post' action='".var_62.'?'.$var_130."' id='core-banlist-form'>
				<fieldset id='core-banlist'>
					<legend class='e-hideme'>".($var_130 == 'list' ? var_265 : var_266)."</legend>
					".$var_59->hidden("ban_secure", "1")."
		";

		$var_267 = ($var_130 == 'white') ? 'banlist_bantype='.var_85::var_86 : 'banlist_bantype!='.var_85::var_86;


		if(!$var_268 = $var_143->db_Select("banlist", "*", $var_267." ORDER BY banlist_ip"))
		{
			
			$var_60->addInfo($var_260[$var_130]);
		}
		else
		{
			$var_61 .= "
					<table class='table adminlist'>
						<colgroup>
			";
			foreach($var_253[$var_130] as $var_270)
			{
				$var_61 .= "
								<col style='width:{$var_270}%' />
				";
			}
			$var_61 .= "
						</colgroup>
						<thead>
							<tr>
			";
			$var_271 = 0;
			foreach($var_254[$var_130] as $var_272)
			{
				$var_271 ++;
				$var_61 .= "<th".(($var_271 == count($var_253[$var_130])) ? " class='center last'" : "").">{$var_272}</th>";
			}
			$var_61 .= "</tr>
						</thead>
						<tbody>";
			while($var_157 = $var_143->db_Fetch())
			{
				
				$var_157['banlist_reason'] = str_replace('LAN_LOGIN_18', var_273, $var_157['banlist_reason']);
				$var_61 .= "<tr>";
				foreach($var_263[$var_130] as $var_274 => $var_275)
				{
					$var_276 = '';
					switch($var_274)
					{
						case 'banlist_datestamp':
							$var_98 = ($var_157['banlist_datestamp'] ? strftime($var_43['ban_date_format'], $var_157['banlist_datestamp']) : var_277);
							break;
						case 'banlist_bantype':
							$var_98 = "<div class='nowrap' title='".$var_40->getBanTypeString($var_157['banlist_bantype'], TRUE)."'>".$var_40->getBanTypeString($var_157['banlist_bantype'], FALSE)." <a href='
							break;
						case 'ip_reason':
							$var_98 = e107::getIPHandler()->ipDecode($var_157['var_37'])."<var_278 />".$var_275.": ".$var_157['banlist_reason'];
							break;
						case 'banlist_banexpires':
							$var_98 = ($var_157['banlist_banexpires'] ? strftime($var_43['ban_date_format'], $var_157['banlist_banexpires']).(($var_157['banlist_banexpires'] < time()) ? ' ('.var_101.')' : '') : var_100)."<br />".fn_12("onchange=\"e107Helper.urlJump('".var_62."?newtime-{$var_157['banlist_ip']}-'+this.value)\"");
							break;
						case 'ban_options':
							$var_276 = ' class="center"';
							$var_98 = "
							<a class='action edit' href='".var_62."?{$var_251}-{$var_157['banlist_ip']}'>".var_279."</a>
<input class='action delete no-confirm' name='delete_ban_entry' value='".var_62."?{$var_252}-{$var_157['banlist_ip']}' type='image' src='".var_280."' alt='".var_281."' title='".$var_41->toJS(var_283." [".e107::getIPHandler()->ipDecode($var_157['banlist_ip'])."]")."' />";
							break;
						case 'banlist_notes':
						default:
							$var_98 = $var_157[$var_274];
					}

					$var_61 .= "<td{$var_276}>{$var_98}</td>";
				}
				$var_61 .= '</tr>';
			}
			$var_61 .= "</tbody>
					</table>
					<script type='text/javascript'>
					(function () {
						var del_sel = \$\$('input[name=delete_ban_entry]');
						del_sel.each(function (element) {
							var msg = element.readAttribute('title');
							element.writeAttribute('title', '".var_281."').writeAttribute('confirm-msg', msg);
						});
						del_sel.invoke('observe', 'click', function (event) {

							var element = event.element(), msg = element.readAttribute('confirm-msg');
							if(!e107Helper.confirm(msg)) { event.stop(); return; }
							\$('core-banlist-form').writeAttribute('action', element.value).submit();
						});
					}())
					</script>
			";
		}
		$var_61 .= "
				</fieldset>
			</form>
		";

		 
	
		
}		





function fn_15()
{
	$var_130 = (var_63) ? var_63 : 'list';

	$var_288['list']['text'] = var_284;		
	$var_288['list']['link'] = var_62.'?list';
	$var_288['list']['perm'] = '4';

	$var_288['add']['text'] = var_285;		
	$var_288['add']['link'] = var_62.'?add';
	$var_288['add']['perm'] = '4';

	$var_288['white']['text'] = var_6;		
	$var_288['white']['link'] = var_62.'?white';
	$var_288['white']['perm'] = '4';

	$var_288['whadd']['text'] = var_7;		
	$var_288['whadd']['link'] = var_62.'?whadd';
	$var_288['whadd']['perm'] = '4';

	$var_288['transfer']['text'] = var_9;
	$var_288['transfer']['link'] = var_62.'?transfer';
	$var_288['transfer']['perm'] = '4';

	if (getperms('0'))
	{
		$var_288['times']['text'] = var_10;
		$var_288['times']['link'] = var_62.'?times';
		$var_288['times']['perm'] = '0';

		$var_288['options']['text'] = var_11;
		$var_288['options']['link'] = var_62.'?options';
		$var_288['options']['perm'] = '0';

		$var_288['banlog']['text'] = var_286;
		$var_288['banlog']['link'] = var_62.'?banlog';
		$var_288['banlog']['perm'] = '0';
	}
	e107::getNav()->admin(var_14, $var_130, $var_288);
}




function fn_16($var_289)
{
	if (strlen($var_289) != 15)
		return 0;
	return mktime(substr($var_289, 9, 2), substr($var_289, 11, 2), substr($var_289, 13, 2), substr($var_289, 4, 2), substr($var_289, 6, 2), substr($var_289, 0, 4));
}





function var_290($var_291, $var_292, $var_293, $var_294 = ',', $var_295 = '"')
{
	$var_143 = e107::getDb();
	$var_43['ban_durations'] = e107::getPref('ban_durations');
	$var_60 = e107::getMessage();
	
	
	
	if ($var_292)
		$var_143->db_Update('banlist', "`banlist_bantype`=".var_85::var_296." WHERE `banlist_bantype` = ".var_85::var_297);
	$var_298 = file($var_291);
	$var_299 = 0;
	foreach ($var_298 as $var_300)
	{ 
		$var_300 = trim($var_300);
		$var_299++;
		if ($var_300)
		{
			$var_24 = explode($var_294, $var_300);
			$var_301 = 0;
			$var_302 = array('banlist_bantype' => var_85::var_297);
			foreach ($var_24 as $var_303)
			{
				$var_303 = trim($var_303);
				if (substr($var_303, 0, 1) == $var_295)
				{
					if (substr($var_303, -1, 1) == $var_295)
					{ 
						$var_303 = substr($var_303, 1, -1);		
					}
					else
					{
						$var_60->addError(var_304.$var_299);
						return var_304.$var_299;
					}
				}
				
				$var_301++;
				switch ($var_301)
				{
					case 1 :	
						$var_302['banlist_ip'] = e107::getIPHandler()->ipEncode($var_303);
						break;
					case 2 :	
						$var_302['banlist_datestamp'] = fn_16($var_303);
						break;
					case 3 :	
						if ($var_293)
						{
							$var_302['banlist_banexpires'] = fn_16($var_303);
						}
						else
						{ 
							$var_302['banlist_banexpires'] = $var_43['ban_durations'][var_85::var_297] ? time() + (3600*$var_43['ban_durations'][var_85::var_297]) : 0;
						}
						break;
					case 4 :	
						break;
					case 5 :	
						$var_302['banlist_reason'] = $var_303;
						break;
					case 6 :	
						$var_302['banlist_notes'] = $var_303;
						break;
					default :	
				}
			}
			$var_145 = "REPLACE INTO `
			
			if (!$var_143->var_306($var_145))
			{
				$var_60->var_234(BANLAN_50.$var_299);
				return BANLAN_50.$var_299;
			}
		}
	}
	
	if ($var_292)
		$var_143->var_151('banlist', "`var_82` = ".var_85::var_296);
	@unlink($var_291);		
	$var_60->var_122(str_replace('[y]', $var_299, var_307).$var_291);
	return str_replace('[y]', $var_299, var_307).$var_291;
}




function fn_17($var_308 = '00', $var_309 = '')
{
	e107::getAdminLog()->log_event('BANLIST_'.$var_308, $var_309, var_311, '');
}



function fn_18()
{

}

var_169;
?>
